<%
 # Use precomputed symbols and strings to avoid allocations
 criterion_str = criterion.to_s
 status_symbol = criterion.status_symbol
 project_criterion_status = project[status_symbol]
 criterion_result = project.get_criterion_result(criterion)
 # Get justification for data attribute
 justification_symbol = criterion.justification_symbol
 project_criterion_justification = project[justification_symbol] || ''

 # All project-specific rendering is outside the cache block.
 passing_class = (criterion_result == :criterion_passing && view_only) ?
                   ' criterion-passing' : ''

 # Automation highlighting (transient per-request state, never cached).
 # Uses precomputed Sets from ProjectsHelper for O(1) lookup.
 highlight_class = ''
 automation_icon = ''
 if automated_field_set.include?(status_symbol)
   highlight_class = " #{ApplicationHelper::HIGHLIGHT_AUTOMATED_CLASS}"
   automation_icon = %(<span class="automation-icon" title="#{t('projects.edit.automation.automated_tooltip')}" aria-hidden="true">#{ApplicationHelper::ROBOT_EMOJI_SAFE}</span>).html_safe
 elsif overridden_field_set.include?(status_symbol)
   highlight_class = ' highlight-overridden'
   automation_icon = %(<span class="override-icon" title="#{t('projects.edit.automation.overridden_tooltip')}" aria-hidden="true">⚠️</span>).html_safe
 end

 is_crypto = criterion_str.start_with?('crypto_')
 crypto_class = is_crypto ? ' criterion-is-crypto' : ''
%>
  <div id="<%= criterion_str %>" class="row criterion-data<%= passing_class %><%= highlight_class %>"
       data-status="<%= status_to_string(project_criterion_status) %>"
       data-justification="<%= h(project_criterion_justification) %>"
       <% if highlight_class.present? %>
       aria-label="<%= highlight_class.include?('automated') ? t('projects.edit.automation.aria_automated') : t('projects.edit.automation.aria_overridden') %>"
       role="status"
       <% end %>>
    <div class="col-md-3 col-sm-4 col-xs-4 criteria-radio<%= crypto_class %>">
      <%= automation_icon.html_safe if automation_icon.present? %>
      <div class="status-chooser">
      <% cache ['buttons', criterion_str, criteria_level, criterion_result,
                view_only, locale, project_criterion_status] do %>
      <%= f.form_group status_symbol do %>
        <%= link_to("##{criterion}") do %>
        <%#
                       !!!!!  IMPORTANT  !!!!!
          The functionality below is mirrored in assets/project-form.js
          in the function "resetCriterionResult".  If you change the code
          below, change "resetCriterionResult" accordingly.
                       !!!!!!!!!!!!!!!!!!!!!!!
        %>
        <div class="col-xs-4 text-left block-left"><br>
          <% if criterion_result == :criterion_passing %>
            <%= image_tag(
                  'result_symbol_check.png', size: '40x40',
                    id: "#{criterion_str}_enough",
                    alt: t('projects.misc.in_javascript.passing_alt')
                ) %>
          <% elsif criterion_result == :criterion_barely %>
            <%= image_tag(
                  'result_symbol_dash.png', size: '40x40',
                    id: "#{criterion_str}_enough",
                    alt: t('projects.misc.in_javascript.barely_alt')
                ) %>
          <% elsif criterion_result == :criterion_failing %>
            <%= image_tag(
                  'result_symbol_x.png', size: '40x40',
                    id: "#{criterion_str}_enough",
                    alt: t('projects.misc.in_javascript.failing_alt')
                ) %>
          <% else %>
            <%= image_tag(
                  'result_symbol_question.png', size: '40x40',
                    id: "#{criterion_str}_enough",
                    alt: t('projects.misc.in_javascript.unknown_alt')
                ) %>
          <% end %>
        <%#            !!!!!!!!!!!!!!!!!!!!!!!            %>
        <% end %>
        </div>
        <div class="col-xs-4 col-xs-offset-2 col-sm-offset-1 text-left block-left">
          <fieldset>
          <legend class="hidden"><%= "Criterion [#{baseline_id_to_display(criterion)}]" %></legend>
          <%= status_radio_button f, project, status_symbol, 'Met',
                                  label: t('criterion_status.Met'), disabled: view_only %>
          <%= status_radio_button f, project, status_symbol, 'Unmet',
                                  label: t('criterion_status.Unmet'), disabled: view_only %>
          <% if criterion.na_allowed? %>
            <%= status_radio_button f, project, status_symbol, 'N/A',
                                    label: t('criterion_status.NA'), disabled: view_only %>
          <% end %>
          <% unless criterion.minor == 'Prerequisites' %>
            <%= status_radio_button f, project, status_symbol, '?',
                                    label: '?', disabled: view_only %>
          <% end %>
          </fieldset>
        </div>
      <% end %>
      <% end # cache 'buttons' %>
      </div>
    </div>
  </div>
  <div class='col-md-9 col-sm-8 col-xs-12 criteria-desc'>
    <% cache_frozen ['desc', criterion_str, criteria_level, locale ] do
       # Here we provide the description, details, and markings like
       # "met_url_required?".  We cache this separately.
       # Its cache needs fewer keys, so by caching this separately it
       # can be shared across more projects. %>
      <br>
      <%= if criterion.future?
           "(#{t('projects.misc.future_criterion')})"
         else
            ''
         end %>
      <%= criterion.description %>
      <%= if criterion.met_url_required?
            "(#{t('projects.misc.url_required')})"
          else
            ''
         end %>
      <sup>[<%= baseline_id_to_display(criterion) %>]</sup>
      <%= if criterion.details
            render(partial: "details",
              locals: {f: f, criterion: criterion,
                       details: criterion.details.html_safe})
          end %>
    <% end # cache 'desc' %>

    </div><%# end of existing column %>
    <div class="col-xs-12"><%# new section for justification and rule %>

    <% # Use precomputed symbol to avoid string concatenation
       justification_symbol = criterion.justification_symbol
       if (view_only)
         project_criterion_justification = project[justification_symbol]
         if project_criterion_justification&.presence
           cache ['markdown', project.id, criterion_str,
                  project.lock_version] do %>
          <div class="justification-markdown" lang="<%= project.entry_locale %>">
            <%= markdown(project_criterion_justification) %>
          </div>
        <% end # cache 'markdown'
         end # if..presence
         if criterion_result == :criterion_url_required %>
           <p class="bg-warning"><%= t('projects.misc.url_required_warning') %></p>
         <% elsif criterion_result == :criterion_justification_required %>
          <p class="bg-warning"><%= t('projects.misc.justification_required_warning') %></p>
         <% end # criterion_result %>
    <% else %>
      <%= f.text_area justification_symbol,
                      class: 'justification-text', hide_label: true,
                      lang: project.entry_locale, spellcheck: true,
                      placeholder:t('projects.misc.in_javascript.unknown_placeholder'),
                      disabled: view_only %>
    <% end # view_only %>
    <% if is_last %>
      <br>
    <% else %>
      <hr>
    <% end %>
    </div>
  </div>
